\section{Properties}

\begin{theorem}[Progress]\label{th:progress}
  Given a well-formed program $(\*\M*, e)$, any expression $e^\prime$ in the
  relation $e \stot e^\prime$ is either an object literal $\O$ or can be reduced
  by an application of $\sto$.

  \begin{lemma}[Substitution Completeness]\label{lem:sub-complete}
    Substitution on a well-typed term always completes.

    \begin{proof}
      A well-typed program must have a finite size, which means every branch
      must bottom out on either a variable, \self, or an empty object literal,
      all of which terminate substitution.  The remaining cases are trivially
      recursive.
    \end{proof}
  \end{lemma}

  \begin{proof}
    A well-typed program has no free variables, so $\xs$ is never encountered in
    reduction.  Inductive steps for method requests $e.m(\*e_i*)$ and
    $\O.m(\*e_i*)$ are trivial, so we need only show that a method request
    $\O.m(\*\O_i*)$ can always proceed and will always complete.
    Rule~\ref{eq:type-obj} guarantees that the requested method always exists in
    the receiver, which is the only requirement for $\sto$ to be applied to this
    form of method request.  The relation is satisfied as long as the
    substitution operation produces an outcome, so due to
    Lemma~\ref{lem:sub-complete}, this single step of $\sto$ is guaranteed to
    complete and produce a new expression $e^\prime$.
  \end{proof}
\end{theorem}

\begin{theorem}[Preservation]\label{th:preservation}
  If $\gctx{e}{\tau}$ and $e \sto e^\prime$, then $\gctx{e^\prime}{\tau^\prime}$
  for some $\tau^\prime \sub \tau$.

  \begin{lemma}[Subtyping Reflexivity]\label{lem:sub-reflexive}
    For any type $\tau$, $\tau \sub \tau$.

    \begin{proof}

    \end{proof}
  \end{lemma}

  \begin{lemma}[Subtyping Transitivity]\label{lem:sub-transitive}
    For any types $\tau$, $\sigma$, and $\upsilon$, if $\tau \sub \sigma$ and
    $\sigma \sub \upsilon$ then $\tau \sub \upsilon$.

    \begin{proof}

    \end{proof}
  \end{lemma}

  \begin{lemma}[Substitution Preservation]\label{lem:preservation}
    If $\ctx{\G, \xs : \upsilon}{e}{\tau}$, and
    $\gctx{e^\prime}{\upsilon^\prime}$ where $\upsilon^\prime \sub \upsilon$,
    then $\gctx{[e^\prime/\xs]e}{\tau^\prime}$ for some $\tau^\prime \sub \tau$.

    \begin{proof}
      By induction on the derivation of $\ctx{\G, \xs : \upsilon}{e}{\tau}$.

      \case{\ref{eq:sub-var}}{e = \xs}
      $\ctx{\G, \xs : \upsilon}{\xs}{\upsilon}$, so $\tau = \upsilon$.
      $[e^\prime/\xs]\xs \bto e^\prime$ and $\gctx{e^\prime}{\upsilon^\prime}$,
      so $\tau^\prime = \upsilon^\prime$.  As $\upsilon^\prime \sub \upsilon$,
      $\tau^\prime \sub \tau$.

      \case{\ref{eq:sub-none}}{e = y~\mathbf{where}~y \neq \xs}
      $[e^\prime/\xs]y \bto y$ and $\gctx{y}{\tau}$, so $\tau^\prime = \tau$.
      Due to Lemma~\ref{lem:sub-reflexive}, $\tau^\prime \sub \tau$.

      \case{\ref{eq:sub-req}}{e = e_0.m(\*e_i*)}
      $\Gamma \vdash e_0 : \tau_0, \*e_i : \sigma_i*$.  By induction,
      $[e^\prime/\xs]e_0 \bto e^\prime_0$ and $\*[e^\prime/\xs]e_i \bto
      e^\prime_i*$ with $\Gamma, \xs : \upsilon \vdash e^\prime_0 :
      \tau_0^\prime, \*e^\prime_i : \sigma_i^\prime*$ where $\tau_0^\prime \sub
      \tau_0$ and $\*\sigma_i^\prime \sub \sigma_i*$.  By
      Rule~\ref{eq:type-req}, there exists a method with head $m(\*x_i :
      \upsilon_i*) \to \tau$ in $\tau_0$ where $\*\sigma_i \sub \upsilon_i*$,
      and as $\tau_0^\prime \sub \tau_0$, by Rule~\ref{eq:type-sub} there exists
      a method with head $m(\*x_i : \upsilon_i^\prime*) \to \sigma$ in
      $\tau_0^\prime$ where $\upsilon_i \sub \upsilon_i^\prime$ and
      $\sigma \sub \tau$.  Due to Lemma~\ref{lem:sub-transitive}, $\*\sigma_i
      \sub \upsilon_i^\prime*$, so $\ctx{\Gamma, \xs :
      \upsilon}{e_0^\prime.m(\*e_i^\prime*)}{\sigma}$.  This means that $\sigma
      = \tau^\prime$, so $\tau^\prime \sub \tau$.

      \case{\ref{eq:sub-obj}}{e = \object{\overline{\method{m}{\*x_{ik} :
        \upsilon_{ik}*}{\sigma_i}{e_i}}}, \xs = x}
      $x \notin \*x_{ik}*$, so by induction $\*[e^\prime/x]e_i \bto e_i^\prime*$
      with $\*\ctx{\Gamma, x : \upsilon}{e_i^\prime}{\sigma_i^\prime}*$ where
      $\*\sigma_i^\prime \sub \sigma_i*$.  This means the object remains
      well-typed, with no change in the static type of the object, so
      $\tau^\prime = \tau$.  Due to Lemma~\ref{lem:sub-reflexive}, $\tau^\prime
      \sub \tau$.

      \case{\ref{eq:sub-self}}{e = \object{\*\M_i*}, \xs = \self}
      $[e^\prime/\self]\object{\*\M_i*} \bto \object{\*\M_i*}$ and
      $\gctx{\object{\*\M_i*}}{\tau}$, so $\tau^\prime = \tau$.  Due to
      Lemma~\ref{lem:sub-reflexive}, $\tau^\prime \sub \tau$.
    \end{proof}
  \end{lemma}

  \begin{proof}
    By induction on a derivation of $e \sto e^\prime$.  The inductive step for
    \textsc{R-Rec} and \textsc{R-Arg} is trivial, so only \textsc{R-Req}
    remains.
%
    \begin{align*}
      &e = \object{\*\M_i*}.m(\*\O_i*) &
      \method{m}{\*x_i : \upsilon_i*}{\sigma}{e_m} \in \*\M_i* \\
      &e^\prime = [\*\O_i/x_i*, \object{\*\M_i*}/\self]e_m &
    \end{align*}

    \noindent By Rules~\ref{eq:type-req} and~\ref{eq:type-obj}, for some types
    $\*\upsilon^\prime_i*$ we have:
%
    \begin{displaymath}
      \G \vdash \object{\*\methh{\H_j}{e_j}*} : \type{\*\H_j*} \quad\quad
      m(\*x_i : \upsilon_i*) \to \sigma \in \*\H_j* \quad\quad
      \G \vdash \*\O_i : \upsilon^\prime_i* \quad\quad
      \*\upsilon^\prime_i \sub \upsilon_i*
    \end{displaymath}

    \noindent By Lemma~? $\*x_i : \upsilon_i*, \self : \type{\H_i} \vdash e_m :
    \tau$ for some type $\tau$ where $\tau \sub \sigma$.  By Lemma~?, $\G, \*x_i
    : \upsilon_i*, \self : \type{\H_i} \vdash e_m : \tau$.  Then, by
    Lemma~\ref{lem:preservation}, $\G \vdash [\*\O_i/x_i,\O/\self*]e_m :
    \tau^\prime$ where $\tau^\prime \sub \tau$.  Due to
    Lemma~\ref{lem:sub-transitive}, $\tau^\prime \sub \sigma$.
  \end{proof}

\end{theorem}

\begin{theorem}[Type Soundness]\label{th:type-soundness}
  If $\varnothing \vdash e : \tau$ and $e \stot e^\prime$ with $e^\prime$ in
  normal form, then $e^\prime$ is an object literal $\O$ with $\varnothing
  \vdash \O : \tau^\prime$ where $\tau^\prime \sub \tau$.

  \begin{proof}
    Immediate from Theorems~\ref{th:progress} and~\ref{th:preservation}.
  \end{proof}
\end{theorem}

